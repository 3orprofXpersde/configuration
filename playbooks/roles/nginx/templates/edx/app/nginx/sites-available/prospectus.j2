{%- if "prospectus" in nginx_default_sites -%}
  {%- set default_site = "default_server" -%}
{%- else -%}
  {%- set default_site = "" -%}
{%- endif -%}

map $uri $cs_whitelist {
  default 0;
  "/professional-certificate/delftx-data-analysis-&-visualization-with-excel" 1;
  "/xseries/microsoft-excel-data-analyst" 1;
  "/professional-certificate/microsoft-introduction-to-professional-software-development" 1;
  "/professional-certificate/microsoft-data-analysis" 1;
  "/micromasters/adelaidex-big-data" 1;
  "/xseries/microsoft-azure-hdinsight-big-data-analyst" 1;
  "/professional-certificate/microsoft-introduction-to-code-objects-and-algorithms" 1;
  "/micromasters/columbiax-artificial-intelligence" 1;
  "/micromasters/curtinx-internet-of-things-iot" 1;
  "/micromasters/uc-san-diegox-data-science" 1;
  "/professional-certificate/microsoft-introduction-to-computer-science" 1;
  "/professional-certificate/dartmouth-imtx-c-programming-with-linux" 1;
  "/professional-certificate/introduction-to-computing-in-python" 1;
  "/professional-certificate/microsoft-introduction-to-code-solutions" 1;
  "/professional-certificate/uc-berkeleyx-blockchain-fundamentals" 1;
  "/micromasters/ubcx-software-development" 1;
  "/micromasters/usmx-umuc-bioinformatics" 1;
  "/micromasters/berkeleyx-marketing-analytics" 1;
  "/professional-certificate/linuxfoundationx-blockchain-for-business" 1;
  "/professional-certificate/uc3mx-introduction-java-programming" 1;
  "/professional-certificate/hkustx-jave-and-android-foundation" 1;
  "/professional-certificate/w3cx-front-end-web-developer" 1;
  "/micromasters/ritx-cybersecurity" 1;
  "/course/big-data-analytics" 1;
  "/course/big-data-fundamentals" 1;
  "/course/computational-thinking-and-big-data" 1;
  "/course/big-data-capstone-project" 1;
  "/course/programming-for-data-science" 1;
  "/course/aws-developer-building-on-aws" 1;
  "/course/marketing-analytics-marketing-measurement-strategy-0" 1;
  "/course/marketing-analytics-price-and-promotion-analytics-0" 1;
  "/course/marketing-analytics-competitive-analysis-and-market-segmentation-0" 1;
  "/course/marketing-analytics-products-distribution-and-sales-0" 1;
  "/course/bitcoin-and-cryptocurrencies" 1;
  "/course/blockchain-technology" 1;
  "/course/product-management-with-lean-agile-and-system-design-thinking-0" 1;
  "/course/designing-experimentation-enhance-bux-qd601x-1" 1;
  "/course/artificial-intelligence-ai" 1;
  "/course/machine-learning" 1;
  "/course/robotics-1" 1;
  "/course/animation-cgi-motion-1" 1;
  "/course/introduction-to-the-internet-of-things-iot-1" 1;
  "/course/iot-networks-and-protocols" 1;
  "/course/iot-programming-and-big-data" 1;
  "/course/cybersecurity-privacy-iot-curtinx-iot5x" 1;
  "/course/programming-in-c-getting-started" 1;
  "/course/c-programming-language-foundations" 1;
  "/course/modular-programming-and-memory-management" 1;
  "/course/programming-in-c-pointers-and-memory-management" 1;
  "/course/c-programming-advanced-data-types" 1;
  "/course/programming-in-c-advanced-data-types" 1;
  "/course/programming-in-c-using-linux-tools-and-libraries" 1;
  "/course/data-analysis-visualization-and-dashboard-design" 1;
  "/course/demystifying-biomedical-big-data-users-georgetownx-biox-201-01x-0" 1;
  "/course/computing-in-python-i-fundamentals-and-procedural-programming-2" 1;
  "/course/computing-in-python-ii-control-structures-2" 1;
  "/course/computing-in-python-iii-data-structures-2" 1;
  "/course/computing-in-python-iv-objects-algorithms-2" 1;
  "/course/cs50s-apr-computer-science-principles-harvardx-cs50-ap" 1;
  "/course/cs50s-computer-science-for-business-professionals" 1;
  "/course/cs50s-web-programming-with-python-and-javascript" 1;
  "/course/cs50s-introduction-computer-science-harvardx-cs50x" 1;
  "/course/using-python-for-research" 1;
  "/course/introduction-java-programming-part-1-hkustx-comp102-1x-9" 1;
  "/course/introduction-java-programming-part-2-hkustx-comp102-2x-9" 1;
  "/course/introduction-mobile-application-hkustx-comp107x-8" 1;
  "/course/blockchain-and-fintech-basics-applications-and-limitations" 1;
  "/course/advanced-algorithmics-and-graph-theory-with-python" 1;
  "/course/blockchain-for-business-an-introduction-to-hyperledger-technologies" 1;
  "/course/microsoft-office-fundamentals-outlook-word-and-excel-1" 1;
  "/course/introduction-to-data-science" 1;
  "/course/microsoft-professional-capstone-data-science" 1;
  "/course/querying-data-with-transact-sql-0" 1;
  "/course/processing-big-data-with-hadoop-in-azure-hdinsight-0" 1;
  "/course/implementing-real-time-analytics-with-hadoop-in-azure-hdinsight-0" 1;
  "/course/implementing-predictive-analytics-with-spark-in-azure-hdinsight" 1;
  "/course/principles-of-machine-learning" 1;
  "/course/introduction-to-r-for-data-science" 1;
  "/course/analyzing-and-visualizing-data-with-power-bi-0" 1;
  "/course/introduction-to-python-for-data-science" 1;
  "/course/programming-in-r-for-data-science" 1;
  "/course/programming-with-python-for-data-science" 1;
  "/course/essential-statistics-for-data-analysis-using-excel" 1;
  "/course/developing-big-data-solutions-with-azure-machine-learning-0" 1;
  "/course/introduction-to-bootstrap-a-tutorial-2" 1;
  "/course/introduction-to-c-sharp-3" 1;
  "/course/intermediate-c" 1;
  "/course/introduction-c-plus-plus-3" 1;
  "/course/developing-dynamic-web-applications-using-angular" 1;
  "/course/advanced-css-concepts-2" 1;
  "/course/asynchronous-programming-with-javascript" 1;
  "/course/introduction-to-python-absolute-beginner-2" 1;
  "/course/introduction-to-design-thinking-2" 1;
  "/course/logic-and-computational-thinking-2" 1;
  "/course/introduction-to-python-fundamentals-2" 1;
  "/course/writing-professional-code-2" 1;
  "/course/learn-to-program-in-java-2" 1;
  "/course/object-oriented-programming-in-java-2" 1;
  "/course/building-interactive-prototypes-using-javascript-2" 1;
  "/course/building-functional-prototypes-using-nodejs-2" 1;
  "/course/introduction-to-reactjs-2" 1;
  "/course/introduction-to-nodejs" 1;
  "/course/designing-a-technical-solution-2" 1;
  "/course/algorithms-and-data-structures-2" 1;
  "/course/angular-fundamentals-2" 1;
  "/course/introduction-to-python-creating-scalable-robust-interactive-code" 1;
  "/course/microsoft-professional-capstone-entry-level-software-development" 1;
  "/course/microsoft-capstone-entry-level-Development" 1;
  "/course/introduction-to-computer-science-and-programming-using-python-0" 1;
  "/course/machine-learning-with-python-from-linear-models-to-deep-learning" 1;
  "/course/cybersecurity-fundamentals-1" 1;
  "/course/computer-forensics-2" 1;
  "/course/cybersecurity-risk-management" 1;
  "/course/network-security-0" 1;
  "/course/cybersecurity-capstone-ritx-cyber525x-2" 1;
  "/course/web-app-development-with-the-power-of-nodejs" 1;
  "/course/how-code-simple-data-ubcx-htc1x" 1;
  "/course/how-code-complex-data-ubcx-htc2x" 1;
  "/course/software-construction-data-abstraction-ubcx-softconst1x" 1;
  "/course/software-construction-object-oriented-ubcx-softconst2x" 1;
  "/course/software-engineering-introduction-ubcx-softeng1x" 1;
  "/course/software-development-capstone-project-ubcx-softengprjx" 1;
  "/course/introduction-to-java-programming-starting-to-code-with-java" 1;
  "/course/introduction-genomic-data-science-uc-san-diegox-cse181-1x" 1;
  "/course/machine-learning-fundamentals-0" 1;
  "/course/big-data-analytics-using-spark-0" 1;
  "/course/statistical-analysis-in-bioinformatics-0" 1;
  "/course/embedded-systems-shape-the-world-microcontroller-inputoutput" 1;
  "/course/css-basics" 1;
  "/course/html5-and-css-fundamentals-2" 1;
  "/course/html5-coding-essentials-and-best-practices" 1;
  "/course/html5-apps-and-games" 1;
  "/course/javascript-introduction" 1;
  "/course/introduction-to-java-programming-writing-good-code" 1;
  "/course/introduction-to-java-programming-fundamental-data-structures-and-algorithms" 1;
  "/course/dna-sequences-alignments-and-analysis" 1;
  "/course/proteins-alignment-analysis-and-structure-0" 1;
}

map $uri $bz_whitelist {
  default 0;
  "/professional-certificate/babsonx-financial-decision-making-for-leaders" 1;
  "/professional-certificate/columbiax-corporate-finance" 1;
  "/micromasters/columbiax-business-analytics" 1;
  "/professional-certificate/tumx-six-sigma-and-lean" 1;
  "/xseries/business-principles-entrepreneurial-thought" 1;
  "/micromasters/iimbx-business-management" 1;
  "/micromasters/bux-digital-product-management" 1;
  "/professional-certificate/dartmouthx-leading-innovation-with-vijay-govindarajan" 1;
  "/professional-certificate/wharton-digital-marketing" 1;
  "/professional-certificate/babsonx-entrepreneurial-mindset-and-leadership" 1;
  "/micromasters/ritx-design-thinking" 1;
  "/micromasters/ritx-project-management" 1;
  "/micromasters/iimbx-entrepreneurship" 1;
  "/micromasters/mitx-supply-chain-management" 1;
  "/micromasters/USMx-UMD-MBA-Core-Curriculum" 1;
  "/professional-certificate/delftx-business-model-innovation" 1;
  "/micromasters/bux-digital-leadership" 1;
  "/professional-certificate/berkeleyx-science-of-happiness-at-work" 1;
  "/micromasters/ubcx-business-fundamentals" 1;
  "/course/financial-accounting-made-fun-eliminating-your-fears" 1;
  "/course/the-entrepreneurial-mindset" 1;
  "/course/financial-analysis-for-decision-making" 1;
  "/course/marketing-fundamentals-who-customer-babsonx-bpet-mktx-0" 1;
  "/course/analytics-for-decision-making" 1;
  "/course/digital-strategy-action-babsonx-bpet-stratx-0" 1;
  "/course/from-corporate-social-responsibility-to-corporate-social-innovation" 1;
  "/course/entrepreneurial-leadership-toolbox1" 1;
  "/course/operations-for-entrepreneurs" 1;
  "/course/business-analytics-fundamentals" 1;
  "/course/the-foundations-of-happiness-at-work" 1;
  "/course/mindfulness-resilience-stress-work-uc-berkeleyx-gg202x" 1;
  "/course/empathy-emotional-intelligence-work-uc-berkeleyx-gg203x" 1;
  "/course/digital-transformation-strategy-1" 1;
  "/course/leading-in-the-digital-age" 1;
  "/course/strategic-social-media-marketing" 1;
  "/course/platform-strategy-for-business" 1;
  "/course/business-analytics-data-driven-decision-bux-qd602x-1" 1;
  "/course/analytics-in-python" 1;
  "/course/data-models-and-decisions-in-business-analytics" 1;
  "/course/demand-supply-analytics-columbiax-bamm-103x-1" 1;
  "/course/marketing-analytics-columbiax-bamm-104x-1" 1;
  "/course/introduction-to-corporate-finance" 1;
  "/course/free-cash-flow-analysis" 1;
  "/course/risk-and-return" 1;
  "/course/iot-capstone-project-curtinx-iot6x" 1;
  "/course/developing-breakthrough-innovations-with-the-three-box-solution" 1;
  "/course/the-value-of-business-models" 1;
  "/course/how-to-design-a-successful-business-model" 1;
  "/course/business-model-testing" 1;
  "/course/business-model-implementation" 1;
  "/course/introduction-to-marketing-tools-to-set-enterprises-apart" 1;
  "/course/entrepreneurship-in-emerging-economies" 1;
  "/course/accounting-for-decision-making" 1;
  "/course/accounting-and-finance-0" 1;
  "/course/do-your-venture-entrepreneurship-for-everyone" 1;
  "/course/corporate-finance-2" 1;
  "/course/introduction-to-investments" 1;
  "/course/people-management" 1;
  "/course/marketing-management-2" 1;
  "/course/operations-management-0" 1;
  "/course/statistics-for-business-i-0" 1;
  "/course/strategic-management" 1;
  "/course/understanding-blockchain-and-its-implications" 1;
  "/course/analyzing-and-visualizing-data-with-excel-0" 1;
  "/course/ulab-leading-change-in-times-of-disruption" 1;
  "/course/supply-chain-comprehensive-exam" 1;
  "/course/supply-chain-analytics" 1;
  "/course/supply-chain-fundamentals" 1;
  "/course/supply-chain-design" 1;
  "/course/supply-chain-dynamics" 1;
  "/course/supply-chain-technology-and-systems" 1;
  "/course/becoming-an-entrepreneur" 1;
  "/course/project-management-life-cycle-0" 1;
  "/course/best-practices-for-project-management-success-0" 1;
  "/course/international-project-management" 1;
  "/course/project-management-micromasters-capstone-exam-1" 1;
  "/course/design-thinking-fundamentals-0" 1;
  "/course/design-thinking-empathizing-to-understand-the-problem-0" 1;
  "/course/design-thinking-ideation-iteration-and-communication" 1;
  "/course/design-thinking-prototyping-and-user-testing" 1;
  "/course/design-thinking-capstone-ritx-think525x" 1;
  "/course/six-sigma-define-and-measure" 1;
  "/course/six-sigma-analyse-improve-control" 1;
  "/course/lean-production" 1;
  "/course/business-foundations-ubcx-bus1x" 1;
  "/course/introduction-accounting-ubcx-busacct1x" 1;
  "/course/organizational-behaviour-ubcx-busobhr1x" 1;
  "/course/introduction-marketing-ubcx-busmktg1x" 1;
  "/course/introduction-corporate-finance-ubcx-busfin1x" 1;
  "/course/market-segmentation" 1;
  "/course/leadership-and-influence" 1;
  "/course/usmx-financial-accounting" 1;
  "/course/data-analysis-for-decision-making" 1;
  "/course/usmx-corporate-finance" 1;
  "/course/marketing-management-0" 1;
  "/course/usmx-global-business-strategy" 1;
  "/course/usmx-strategic-and-transformational-it" 1;
  "/course/fundamentals-of-digital-marketing-social-media-and-e-commerce-0" 1;
  "/course/selling-ideas-how-to-influence-others-and-get-your-message-to-catch-on-0" 1;
  "/course/executing-breakthrough-innovations-with-the-three-box-solution" 1;
  "/course/managing-the-value-of-customer-relationships-0" 1;
  "/course/marketing-analytics-data-tools-and-techniques-3" 1;
}

server {
  # Prospectus configuration file for nginx, templated by ansible

  {% if NGINX_PROSPECTUS_PROXY_INTERCEPT_ERRORS %}
  proxy_intercept_errors on;
  {% endif %}

  listen {{ PROSPECTUS_NGINX_PORT }} {{ default_site }};

  root {{ PROSPECTUS_DATA_DIR }};

  # Ignore the rollout group headers for the health check endpoint.
  location /HealthCheck {
    try_files $uri $uri/index.html @drupal;
  }

  location /admin/ {
    add_header 'Cache-Control' 'public, max-age=0, must-revalidate';
    try_files $uri @drupal;
  }

  location /static/ {
    add_header 'Cache-Control' 'public, max-age=31536000, immutable';
  }

  location / {
    set $cs_control "0:0";
    if ($http_x_rollout_group ~ "cs_control") {
      set $cs_control "${cs_whitelist}:1";
    }

    if ($cs_control = "1:1") {
      proxy_pass {{ PROSPECTUS_PROXY_PASS }};
    }

    set $bz_control "0:0";
    if ($http_x_rollout_group ~ "bz_control") {
      set $bz_control "${bz_whitelist}:1";
    }

    if ($bz_control = "1:1") {
      proxy_pass {{ PROSPECTUS_PROXY_PASS }};
    }
    location ~ \.(js|css)$ {
      add_header 'Cache-Control' 'public, max-age=31536000, immutable';
      try_files $uri @drupal;
    }
    try_files $uri @index;
  }

  location @index {
    add_header 'Cache-Control' 'public, max-age=0, must-revalidate';
    try_files $uri/index.html @drupal;
  }

  location @drupal {
    add_header 'Cache-Control' '';
    proxy_pass {{ PROSPECTUS_PROXY_PASS }};
  }

}